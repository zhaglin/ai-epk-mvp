(()=>{var a={};a.id=431,a.ids=[431],a.modules={93:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>P,patchFetch:()=>O,routeModule:()=>K,serverHooks:()=>N,workAsyncStorage:()=>L,workUnitAsyncStorage:()=>M});var d={};c.r(d),c.d(d,{OPTIONS:()=>J,POST:()=>I});var e=c(5736),f=c(9117),g=c(4044),h=c(9326),i=c(2324),j=c(261),k=c(4290),l=c(5328),m=c(8928),n=c(6595),o=c(3421),p=c(7679),q=c(1681),r=c(3446),s=c(6439),t=c(1356),u=c(641),v=c(9748),w=c(3873),x=c(9021),y=c(7786),z=c.n(y);let A=process.env.REPLICATE_API_TOKEN;A||console.warn("[AI Image] WARNING: REPLICATE_API_TOKEN is not set!");let B=new(z())({auth:A}),C="nightmareai/real-esrgan:42fed1c4974146d4d2414e2be2c5277c7fcf05fcc3a73abf41610695738c1d7b";async function D(a,b={}){let c=Date.now(),d=b.style||"natural",e=b.intensity||"medium",f=b.seed||Math.floor(1e6*Math.random());try{let b;if(console.log("[AI Image Pro] Starting professional enhancement pipeline...",{style:d,intensity:e,seed:f}),!A)throw Error("REPLICATE_API_TOKEN is not configured");let g=a.toString("base64"),h=`data:image/jpeg;base64,${g}`;console.log("[AI Image Pro] Image prepared for Replicate (size:",a.length,"bytes)"),console.log("[AI Image Pro] Light quality enhancement (no face/style changes)...");let i=await B.run(C,{input:{image:h,scale:2,face_enhance:!1}});if(Array.isArray(i)){let a=i[0],c="string"==typeof a?a:a.url();b="string"==typeof c?c:c.toString()}else{let a="string"==typeof i?i:i.url();b="string"==typeof a?a:a.toString()}console.log("[AI Image Pro] Enhanced URL (face preserved):",b);let j=Date.now()-c;return console.log("[AI Image Pro] Professional enhancement completed!",{processingTime:j,seed:f,style:d,intensity:e}),{success:!0,enhancedImageUrl:b,processingTime:j,seed:f,style:d,intensity:e}}catch(a){return console.error("[AI Image Pro] Professional enhancement failed:",a),{success:!1,error:a instanceof Error?a.message:"Professional enhancement failed",seed:f,style:d,intensity:e}}}async function E(a){let b=Date.now();try{let c;console.log("[AI Image] Starting Real-ESRGAN portrait enhancement...");let d=a.toString("base64"),e=`data:image/jpeg;base64,${d}`;console.log("[AI Image] Image prepared for Real-ESRGAN (size:",a.length,"bytes)");let f=await B.run(C,{input:{image:e,scale:2,face_enhance:!0}}),g=Date.now()-b;if(console.log("[AI Image] Real-ESRGAN enhancement completed in",g,"ms"),Array.isArray(f)){let a=f[0],b="string"==typeof a?a:a.url();c="string"==typeof b?b:b.toString()}else{let a="string"==typeof f?f:f.url();c="string"==typeof a?a:a.toString()}if(!c||"string"!=typeof c)throw Error("Invalid output from Real-ESRGAN model");return{success:!0,enhancedImageUrl:c,processingTime:g}}catch(a){return console.error("[AI Image] Real-ESRGAN enhancement failed:",a),{success:!1,error:a instanceof Error?a.message:"Real-ESRGAN enhancement failed"}}}async function F(a){let b=Date.now();try{let c;console.log("[AI Image] Starting CodeFormer face enhancement...");let d=a.toString("base64"),e=`data:image/jpeg;base64,${d}`;console.log("[AI Image] Image prepared for CodeFormer (size:",a.length,"bytes)");let f=await B.run("sczhou/codeformer:7de2ea26c616d5bf2245ad0d5e24f0ff9a6204578a5c876db53142edd9d2cd56",{input:{image:e,upscale:2,face_upsample:!0,background_enhance:!0,codeformer_fidelity:.9}}),g=Date.now()-b;if(console.log("[AI Image] CodeFormer face enhancement completed in",g,"ms"),Array.isArray(f)){let a=f[0],b="string"==typeof a?a:a.url();c="string"==typeof b?b:b.toString()}else{let a="string"==typeof f?f:f.url();c="string"==typeof a?a:a.toString()}if(!c||"string"!=typeof c)throw Error("Invalid output from CodeFormer model");return{success:!0,enhancedImageUrl:c,processingTime:g}}catch(a){return console.error("[AI Image] CodeFormer face enhancement failed:",a),{success:!1,error:a instanceof Error?a.message:"CodeFormer face enhancement failed"}}}var G=c(9288),H=c.n(G);async function I(a){try{let b,{fileId:c,fileName:d,style:e,intensity:f,seed:g}=await a.json();if(!c&&!d)return u.NextResponse.json({error:"File ID or file name is required"},{status:400});let h=d||`${c}.jpg`,i=e||"natural",j=f||"medium";console.log("[Enhance] Starting AI enhancement for file:",h,{style:i,intensity:j,seed:g});let k=(0,w.join)(process.cwd(),"tmp","uploads",h);if(!(0,x.existsSync)(k))return u.NextResponse.json({error:"Temporary file not found"},{status:404});let l=await (0,v.readFile)(k),m=function(a){if(a.length>0xa00000)return{valid:!1,error:"Image too large. Maximum size is 10MB."};if(a.length<1024)return{valid:!1,error:"Image too small. Minimum size is 1KB."};let b=a.slice(0,4),c=255===b[0]&&216===b[1],d=137===b[0]&&80===b[1]&&78===b[2]&&71===b[3],e=82===b[0]&&73===b[1]&&70===b[2]&&70===b[3];return c||d||e?{valid:!0}:{valid:!1,error:"Unsupported image format. Please use JPEG, PNG, or WebP."}}(l);if(!m.valid)return u.NextResponse.json({error:m.error},{status:400});console.log("[Enhance] Image validated, starting processing...");let n=0;console.log("[Enhance] Starting AI-only enhancement (no fallback)...");let o=await D(l,{style:i,intensity:j,seed:g});if(o.success||(console.log("[Enhance] Pro pipeline failed, trying Real-ESRGAN only..."),o=await E(l)),o.success||(console.log("[Enhance] Real-ESRGAN failed, trying CodeFormer..."),o=await F(l)),!o.success)throw Error(`All AI models failed: ${o.error||"Unknown error"}`);console.log("[Enhance] Downloading AI enhanced image from:",o.enhancedImageUrl);let p=await fetch(o.enhancedImageUrl);if(!p.ok)throw Error("Failed to download enhanced image");b=Buffer.from(await p.arrayBuffer()),n=o.processingTime||0;let q=await H()(b).modulate({brightness:1.05,saturation:1.08}).sharpen(1.2).linear(1.05,0).jpeg({quality:92,chromaSubsampling:"4:4:4"}).toBuffer(),r=`enhanced_${c}_${Date.now()}.jpg`,s=(0,w.join)(process.cwd(),"public","generated",r);await (0,v.writeFile)(s,q);let t=`/generated/${r}`;console.log("[Enhance] Enhancement completed successfully:",{fileId:c,finalFileName:r,enhancedUrl:t,processingTime:n});try{await (0,v.unlink)(k),console.log("[Enhance] Temporary file deleted:",k)}catch(a){console.warn("[Enhance] Failed to delete temporary file:",a)}return u.NextResponse.json({success:!0,enhancedUrl:t,fileName:r,processingTime:n,message:"Photo enhanced successfully!"})}catch(a){return console.error("[Enhance] Error during enhancement:",a),u.NextResponse.json({success:!1,error:"Failed to enhance photo",details:a instanceof Error?a.message:"Unknown error",fallback:!0},{status:500})}}async function J(){return new u.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}let K=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/enhance-photo/route",pathname:"/api/enhance-photo",filename:"route",bundlePath:"app/api/enhance-photo/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/zhaglin/ai-epk-mvp/netlify-deploy/app/api/enhance-photo/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:L,workUnitAsyncStorage:M,serverHooks:N}=K;function O(){return(0,g.patchFetch)({workAsyncStorage:L,workUnitAsyncStorage:M})}async function P(a,b,c){var d;let e="/api/enhance-photo/route";"/index"===e&&(e="/");let g=await K.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||K.isDev||x||(F="/index"===(F=C)?"/":F);let G=!0===K.isDev||!E,H=E&&!G,I=a.method||"GET",J=(0,i.getTracer)(),L=J.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:G,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:H,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>K.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>K.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=J.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${I} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${I} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!E)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await K.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})},z),b}},l=await K.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await J.withPropagatedContext(a.headers,()=>J.trace(m.BaseServerSpan.handleRequest,{spanName:`${I} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":I,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await K.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},709:a=>{var b=Object.defineProperty,c=Object.getOwnPropertyDescriptor,d=Object.getOwnPropertyNames,e=Object.prototype.hasOwnProperty,f={};((a,c)=>{for(var d in c)b(a,d,{get:c[d],enumerable:!0})})(f,{EventSourceParserStream:()=>h}),a.exports=((a,f,g,h)=>{if(f&&"object"==typeof f||"function"==typeof f)for(let g of d(f))e.call(a,g)||void 0===g||b(a,g,{get:()=>f[g],enumerable:!(h=c(f,g))||h.enumerable});return a})(b({},"__esModule",{value:!0}),f);var g=[239,187,191],h=class extends TransformStream{constructor(){let a;super({start(b){a=function(a){let b,c,d,e,f,h,i;return j(),{feed:function(j){var k;c=c?c+j:j,b&&(k=c,g.every((a,b)=>k.charCodeAt(b)===a))&&(c=c.slice(g.length)),b=!1;let l=c.length,m=0,n=!1;for(;m<l;){let b;n&&("\n"===c[m]&&++m,n=!1);let g=-1,j=e;for(let a=d;g<0&&a<l;++a)":"===(b=c[a])&&j<0?j=a-m:"\r"===b?(n=!0,g=a-m):"\n"===b&&(g=a-m);if(g<0){d=l-m,e=j;break}d=0,e=-1,function(b,c,d,e){if(0===e){i.length>0&&(a({type:"event",id:f,event:h||void 0,data:i.slice(0,-1)}),i="",f=void 0),h=void 0;return}let g=d<0,j=b.slice(c,c+(g?e:d)),k=0;k=g?e:" "===b[c+d+1]?d+2:d+1;let l=c+k,m=e-k,n=b.slice(l,l+m).toString();if("data"===j)i+=n?"".concat(n,"\n"):"\n";else if("event"===j)h=n;else if("id"!==j||n.includes("\0")){if("retry"===j){let b=parseInt(n,10);Number.isNaN(b)||a({type:"reconnect-interval",value:b})}}else f=n}(c,m,j,g),m+=g+1}m===l?c="":m>0&&(c=c.slice(m))},reset:j};function j(){b=!0,c="",d=0,e=-1,f=void 0,h=void 0,i=""}}(a=>{"event"===a.type&&b.enqueue(a)})},transform(b){a.feed(b)}})}}},740:(a,b,c)=>{let d=c(1208),{create:e}=c(4269);async function f(a,b,c){var d;let e=new TextEncoder,f=await c.subtle.importKey("raw",(d=a,Uint8Array.from(atob(d),a=>a.codePointAt(0))),{name:"HMAC",hash:"SHA-256"},!1,["sign"]);return g(await c.subtle.sign("HMAC",f,e.encode(b)))}function g(a){return btoa(String.fromCharCode.apply(null,new Uint8Array(a)))}async function h(a,b){return await j(b,async b=>b instanceof Blob||b instanceof Buffer?(await e.call(a,b)).urls.get:b)}async function i(a){let b=0;return await j(a,async a=>{let c,d;if(a instanceof Blob)c=await a.arrayBuffer(),d=a.type;else{if(!k(a))return a;c=a}if((b+=c.byteLength)>1e7)throw Error(`Combined filesize of prediction ${b} bytes exceeds 10mb limit for inline encoding, please provide URLs instead`);let e=g(c);return d=d||"application/octet-stream",`data:${d};base64,${e}`})}async function j(a,b){if(Array.isArray(a)){let c=[];for(let d of a){let a=await j(d,b);c.push(a)}return c}if(function(a){if("object"!=typeof a||null===a||"[object Object]"!==String(a))return!1;let b=Object.getPrototypeOf(a);if(null===b)return!0;let c=Object.prototype.hasOwnProperty.call(b,"constructor")&&b.constructor;return"function"==typeof c&&c instanceof c&&Function.prototype.toString.call(c)===Function.prototype.toString.call(Object)}(a)){let c={};for(let d of Object.keys(a))c[d]=await j(a[d],b);return c}return await b(a)}function k(a){return a instanceof Int8Array||a instanceof Int16Array||a instanceof Int32Array||a instanceof Uint8Array||a instanceof Uint8ClampedArray||a instanceof Uint16Array||a instanceof Uint32Array||a instanceof Float32Array||a instanceof Float64Array}a.exports={transform:j,transformFileInputs:async function a(a,b,c){switch(c){case"data-uri":return await i(a,b);case"upload":return await h(a,b);case"default":try{return await h(a,b)}catch(a){if(a instanceof d&&a.response.status>=400&&a.response.status<500)throw a;return await i(b)}default:throw Error(`Unexpected file upload strategy: ${c}`)}},validateWebhook:async function a(a,b,c){let d,e,g,h,i,j=globalThis.crypto;if(a&&a.headers&&a.body){if("function"==typeof a.headers.get?(d=a.headers.get("webhook-id"),g=a.headers.get("webhook-timestamp"),h=a.headers.get("webhook-signature")):(d=a.headers["webhook-id"],g=a.headers["webhook-timestamp"],h=a.headers["webhook-signature"]),e=a.body,"string"!=typeof b)throw Error("Unexpected value for secret passed to validateWebhook, expected a string");i=b,c&&(j=c)}else d=a.id,e=a.body,g=a.timestamp,h=a.signature,i=a.secret,b&&(j=b);if(e instanceof ReadableStream||e.readable)try{e=await new Response(e).text()}catch(a){throw Error(`Error reading body: ${a.message}`)}else if(k(e))e=await new Blob([e]).text();else if("object"==typeof e)e=JSON.stringify(e);else if("string"!=typeof e)throw Error("Invalid body type");if(!d||!g||!h)throw Error("Missing required webhook headers");if(!e)throw Error("Missing required body");if(!i)throw Error("Missing required secret");if(!j)throw Error('Missing `crypto` implementation. If using Node 18 pass in require("node:crypto").webcrypto');let l=`${d}.${g}.${e}`,m=await f(i.split("_").pop(),l,j);return h.split(" ").map(a=>a.split(",")[1]).some(a=>a===m)},withAutomaticRetries:async function a(b,c={}){let e=c.shouldRetry||(()=>!1),f=c.maxRetries||5,g=c.interval||500,h=c.jitter||100,i=a=>new Promise(b=>setTimeout(b,a)),j=0;do{let a=g*2**j+Math.random()*h;try{let a=await b();if(a.ok||!e(a))return a}catch(b){if(b instanceof d){let c=b.response.headers.get("Retry-After");if(c)if(Number.isInteger(c))a=1e3*c;else{let b=new Date(c);Number.isNaN(b.getTime())||(a=b.getTime()-new Date().getTime())}}}Number.isInteger(f)&&f>0&&(Number.isInteger(a)&&a>0&&await i(g*2**(c.maxRetries-f)),j+=1)}while(j<f);return b()},parseProgressFromLogs:function(a){let b="object"==typeof a&&a.logs?a.logs:a;if(!b||"string"!=typeof b)return null;let c=/^\s*(\d+)%\s*\|.+?\|\s*(\d+)\/(\d+)/;for(let a of b.split("\n").reverse()){let b=a.match(c);if(b&&4===b.length)return{percentage:parseInt(b[1],10)/100,current:parseInt(b[2],10),total:parseInt(b[3],10)}}return null},streamAsyncIterator:async function*(a){let b=a.getReader();try{for(;;){let{done:a,value:c}=await b.read();if(a)return;yield c}}finally{b.releaseLock()}}}},846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1128:(a,b,c)=>{let d=c(1208),{streamAsyncIterator:e}=c(740),{EventSourceParserStream:f}=c(709),{TextDecoderStream:g}=void 0===globalThis.TextDecoderStream?c(6268):globalThis;class h{constructor(a,b,c,d){this.event=a,this.data=b,this.id=c,this.retry=d}toString(){return"output"===this.event?this.data:""}}function i({url:a,fetch:b}){let c="application/octet-stream";class f extends ReadableStream{async blob(){let a=[];for await(let b of this)a.push(b);return new Blob(a,{type:c})}url(){return new URL(a)}toString(){return a}}return new f({async start(f){let g=await b(a);if(!g.ok){let b=await g.text(),c=new Request(a,init);f.error(new d(`Request to ${a} failed with status ${g.status}: ${b}`,c,g))}g.headers.get("Content-Type")&&(c=g.headers.get("Content-Type"));try{for await(let a of e(g.body))f.enqueue(a);f.close()}catch(a){f.error(a)}}})}a.exports={createFileOutput:i,createReadableStream:function({url:a,fetch:b,options:c={}}){let{useFileOutput:j=!0,headers:k={},...l}=c;return new ReadableStream({async start(c){let m={...l,headers:{...k,Accept:"text/event-stream"}},n=await b(a,m);if(!n.ok){let b=await n.text(),e=new Request(a,m);c.error(new d(`Request to ${a} failed with status ${n.status}: ${b}`,e,n))}for await(let a of e(n.body.pipeThrough(new g).pipeThrough(new f))){if("error"===a.event){c.error(Error(a.data));break}let d=a.data;if(j&&"string"==typeof d&&(d.startsWith("https:")||d.startsWith("data:"))&&(d=i({data:d,fetch:b})),c.enqueue(new h(a.event,d,a.id)),"done"===a.event)break}c.close()}})},ServerSentEvent:h}},1208:a=>{class b extends Error{constructor(a,b,c){super(a),this.name="ApiError",this.request=b,this.response=c}}a.exports=b},3033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3230:a=>{a.exports={get:async function(a,b,{signal:c}={}){return(await this.request(`/models/${a}/${b}`,{method:"GET",signal:c})).json()},list:async function({signal:a}={}){return(await this.request("/models",{method:"GET",signal:a})).json()},create:async function(a,b,c){let{signal:d,...e}=c,f={owner:a,name:b,...e};return(await this.request("/models",{method:"POST",data:f,signal:d})).json()},versions:{list:async function(a,b,{signal:c}={}){return(await this.request(`/models/${a}/${b}/versions`,{method:"GET",signal:c})).json()},get:async function(a,b,c,{signal:d}={}){return(await this.request(`/models/${a}/${b}/versions/${c}`,{method:"GET",signal:d})).json()}},search:async function(a,{signal:b}={}){return(await this.request("/models",{method:"QUERY",headers:{"Content-Type":"text/plain"},data:a,signal:b})).json()}}},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3410:(a,b,c)=>{let{transformFileInputs:d}=c(740);a.exports={predictions:{create:async function(a,b,c){let{input:e,wait:f,signal:g,...h}=c;if(h.webhook)try{new URL(h.webhook)}catch(a){throw Error("Invalid webhook URL")}let i={};if(f)if("number"==typeof f){let a=Math.max(1,Math.ceil(Number(f))||1);i.Prefer=`wait=${a}`}else i.Prefer="wait";return(await this.request(`/deployments/${a}/${b}/predictions`,{method:"POST",headers:i,data:{...h,input:await d(this,e,this.fileEncodingStrategy)},signal:g})).json()}},get:async function(a,b,{signal:c}={}){return(await this.request(`/deployments/${a}/${b}`,{method:"GET",signal:c})).json()},create:async function(a,{signal:b}={}){return(await this.request("/deployments",{method:"POST",data:a,signal:b})).json()},update:async function(a,b,c,{signal:d}={}){return(await this.request(`/deployments/${a}/${b}`,{method:"PATCH",data:c,signal:d})).json()},list:async function({signal:a}={}){return(await this.request("/deployments",{method:"GET",signal:a})).json()},delete:async function(a,b,{signal:c}={}){return 204===(await this.request(`/deployments/${a}/${b}`,{method:"DELETE",signal:c})).status}}},3762:a=>{a.exports={default:{secret:{get:async function({signal:a}={}){return(await this.request("/webhooks/default/secret",{method:"GET",signal:a})).json()}}}}},3851:a=>{a.exports={get:async function(a,{signal:b}={}){return(await this.request(`/collections/${a}`,{method:"GET",signal:b})).json()},list:async function({signal:a}={}){return(await this.request("/collections",{method:"GET",signal:a})).json()}}},3873:a=>{"use strict";a.exports=require("path")},4011:a=>{"use strict";a.exports=JSON.parse('{"name":"replicate","version":"1.3.0","description":"JavaScript client for Replicate","repository":"github:replicate/replicate-javascript","homepage":"https://github.com/replicate/replicate-javascript#readme","bugs":"https://github.com/replicate/replicate-javascript/issues","license":"Apache-2.0","main":"index.js","type":"commonjs","types":"index.d.ts","files":["CONTRIBUTING.md","LICENSE","README.md","index.d.ts","index.js","lib/**/*.js","vendor/**/*","package.json"],"engines":{"node":">=18.0.0","npm":">=7.19.0","git":">=2.11.0","yarn":">=1.7.0"},"scripts":{"check":"tsc","format":"biome format . --write","lint-biome":"biome lint .","lint-publint":"publint","lint":"npm run lint-biome && npm run lint-publint","test":"jest"},"optionalDependencies":{"readable-stream":">=4.0.0"},"devDependencies":{"@biomejs/biome":"^1.4.1","@types/jest":"^29.5.3","@typescript-eslint/eslint-plugin":"^5.56.0","cross-fetch":"^3.1.5","jest":"^29.7.0","nock":"^14.0.0-beta.6","publint":"^0.2.7","ts-jest":"^29.1.0","typescript":"^5.0.2"}}')},4269:a=>{a.exports={create:async function(a,b={},{signal:c}={}){let d,e,f=new FormData;if(a instanceof Blob)d=a.name||`blob_${Date.now()}`,e=a;else if(Buffer.isBuffer(a))d=`buffer_${Date.now()}`,e=new Blob([new Uint8Array(a)],{type:"application/octet-stream",name:d});else throw Error("Invalid file argument, must be a Blob, File or Buffer");return f.append("content",e,d),f.append("metadata",new Blob([JSON.stringify(b)],{type:"application/json"})),(await this.request("/files",{method:"POST",data:f,headers:{"Content-Type":"multipart/form-data"},signal:c})).json()},list:async function({signal:a}={}){return(await this.request("/files",{method:"GET",signal:a})).json()},get:async function(a,{signal:b}={}){return(await this.request(`/files/${a}`,{method:"GET",signal:b})).json()},delete:async function(a,{signal:b}={}){return 204===(await this.request(`/files/${a}`,{method:"DELETE",signal:b})).status}}},4870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5272:a=>{a.exports={list:async function({signal:a}={}){return(await this.request("/hardware",{method:"GET",signal:a})).json()}}},6268:a=>{var b=Object.defineProperty,c=Object.getOwnPropertyDescriptor,d=Object.getOwnPropertyNames,e=Object.prototype.hasOwnProperty,f={};((a,c)=>{for(var d in c)b(a,d,{get:c[d],enumerable:!0})})(f,{TextDecoderStream:()=>j}),a.exports=((a,f,g,h)=>{if(f&&"object"==typeof f||"function"==typeof f)for(let g of d(f))e.call(a,g)||void 0===g||b(a,g,{get:()=>f[g],enumerable:!(h=c(f,g))||h.enumerable});return a})(b({},"__esModule",{value:!0}),f);var g=Symbol("decDecoder"),h=Symbol("decTransform"),i=class{constructor(a){this.decoder_=a}transform(a,b){if(!(a instanceof ArrayBuffer||ArrayBuffer.isView(a)))throw TypeError("Input data must be a BufferSource");let c=this.decoder_.decode(a,{stream:!0});0!==c.length&&b.enqueue(c)}flush(a){let b=this.decoder_.decode();0!==b.length&&a.enqueue(b)}},j=class{constructor(a,b){let c=new TextDecoder(a||"utf-8",b||{});this[g]=c,this[h]=new TransformStream(new i(c))}get encoding(){return this[g].encoding}get fatal(){return this[g].fatal}get ignoreBOM(){return this[g].ignoreBOM}get readable(){return this[h].readable}get writable(){return this[h].writable}};Symbol("encEncoder"),Symbol("encTransform")},6308:a=>{a.exports={current:async function({signal:a}={}){return(await this.request("/account",{method:"GET",signal:a})).json()}}},6439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},6487:()=>{},7723:a=>{class b{constructor(a,b,c=null){this.owner=a,this.name=b,this.version=c}static parse(a){let c=a.match(/^(?<owner>[^/]+)\/(?<name>[^/:]+)(:(?<version>.+))?$/);if(!c)throw Error(`Invalid reference to model version: ${a}. Expected format: owner/name or owner/name:version`);let{owner:d,name:e,version:f}=c.groups;return new b(d,e,f)}}a.exports=b},7786:(a,b,c)=>{let d=c(1208),e=c(7723),{createReadableStream:f,createFileOutput:g}=c(1128),{transform:h,withAutomaticRetries:i,validateWebhook:j,parseProgressFromLogs:k,streamAsyncIterator:l}=c(740),m=c(6308),n=c(3851),o=c(3410),p=c(4269),q=c(5272),r=c(3230),s=c(8768),t=c(8285),u=c(3762),v=c(4011);class w{constructor(a={}){this.auth=a.auth||("undefined"!=typeof process?process.env.REPLICATE_API_TOKEN:null),this.userAgent=a.userAgent||`replicate-javascript/${v.version}`,this.baseUrl=a.baseUrl||"https://api.replicate.com/v1",this.fetch=a.fetch||globalThis.fetch,this.fileEncodingStrategy=a.fileEncodingStrategy||"default",this.useFileOutput=!1!==a.useFileOutput,this.accounts={current:m.current.bind(this)},this.collections={list:n.list.bind(this),get:n.get.bind(this)},this.deployments={get:o.get.bind(this),create:o.create.bind(this),update:o.update.bind(this),delete:o.delete.bind(this),list:o.list.bind(this),predictions:{create:o.predictions.create.bind(this)}},this.files={create:p.create.bind(this),get:p.get.bind(this),list:p.list.bind(this),delete:p.delete.bind(this)},this.hardware={list:q.list.bind(this)},this.models={get:r.get.bind(this),list:r.list.bind(this),create:r.create.bind(this),versions:{list:r.versions.list.bind(this),get:r.versions.get.bind(this)},search:r.search.bind(this)},this.predictions={create:s.create.bind(this),get:s.get.bind(this),cancel:s.cancel.bind(this),list:s.list.bind(this)},this.trainings={create:t.create.bind(this),get:t.get.bind(this),cancel:t.cancel.bind(this),list:t.list.bind(this)},this.webhooks={default:{secret:{get:u.default.secret.get.bind(this)}}}}async run(a,b,c){let d,{wait:f={mode:"block"},signal:i,...j}=b,k=e.parse(a);if(k.version)d=await this.predictions.create({...j,version:k.version,wait:"block"===f.mode&&(f.timeout??!0)});else if(k.owner&&k.name)d=await this.predictions.create({...j,model:`${k.owner}/${k.name}`,wait:"block"===f.mode&&(f.timeout??!0)});else throw Error("Invalid model version identifier");if(c&&c(d),("block"!==f.mode||"starting"===d.status)&&(d=await this.wait(d,{interval:"poll"===f.mode?f.interval:void 0},async a=>(c&&c(a),!!i&&!!i.aborted))),i&&i.aborted&&(d=await this.predictions.cancel(d.id)),c&&c(d),"failed"===d.status)throw Error(`Prediction failed: ${d.error}`);return h(d.output,a=>"string"==typeof a&&(a.startsWith("https:")||a.startsWith("data:"))&&this.useFileOutput?g({url:a,fetch:this.fetch}):a)}async request(a,b){let c,e,{auth:f,baseUrl:g,userAgent:h}=this;c=a instanceof URL?a:new URL(a.startsWith("/")?a.slice(1):a,g.endsWith("/")?g:`${g}/`);let{method:j="GET",params:k={},data:l,signal:m}=b;for(let[a,b]of Object.entries(k))c.searchParams.append(a,b);let n={"Content-Type":"application/json","User-Agent":h};if(f&&(n.Authorization=`Bearer ${f}`),b.headers)for(let[a,c]of Object.entries(b.headers))n[a]=c;l instanceof FormData?(e=l,delete n["Content-Type"]):l&&(e=JSON.stringify(l));let o={method:j,headers:n,body:e,signal:m},p="GET"===j?a=>429===a.status||a.status>=500:a=>429===a.status,q=this.fetch,r=await i(async()=>q(c,o),{shouldRetry:p});if(!r.ok){let a=new Request(c,o),b=await r.text();throw new d(`Request to ${c} failed with status ${r.status} ${r.statusText}: ${b}.`,a,r)}return r}async *stream(a,b){let c,{wait:d,signal:g,...h}=b,i=e.parse(a);if(i.version)c=await this.predictions.create({...h,version:i.version});else if(i.owner&&i.name)c=await this.predictions.create({...h,model:`${i.owner}/${i.name}`});else throw Error("Invalid model version identifier");if(c.urls&&c.urls.stream){let a=f({url:c.urls.stream,fetch:this.fetch,...g?{options:{signal:g}}:{}});yield*l(a)}else throw Error("Prediction does not support streaming")}async *paginate(a,b={}){let c=await a();if(yield c.results,c.next&&!(b.signal&&b.signal.aborted)){let a=()=>this.request(c.next,{method:"GET",signal:b.signal}).then(a=>a.json());yield*this.paginate(a,b)}}async wait(a,b,c){let{id:d}=a;if(!d)throw Error("Invalid prediction");if("succeeded"===a.status||"failed"===a.status||"canceled"===a.status)return a;let e=a=>new Promise(b=>setTimeout(b,a)),f=b&&b.interval||500,g=await this.predictions.get(d);for(;"succeeded"!==g.status&&"failed"!==g.status&&"canceled"!==g.status&&(!c||await c(g)!==!0);)await e(f),g=await this.predictions.get(a.id);if("failed"===g.status)throw Error(`Prediction failed: ${g.error}`);return g}}a.exports=w,a.exports.validateWebhook=j,a.exports.parseProgressFromLogs=k},8285:a=>{a.exports={create:async function(a,b,c,d){let{signal:e,...f}=d;if(f.webhook)try{new URL(f.webhook)}catch(a){throw Error("Invalid webhook URL")}return(await this.request(`/models/${a}/${b}/versions/${c}/trainings`,{method:"POST",data:f,signal:e})).json()},get:async function(a,{signal:b}={}){return(await this.request(`/trainings/${a}`,{method:"GET",signal:b})).json()},cancel:async function(a,{signal:b}={}){return(await this.request(`/trainings/${a}/cancel`,{method:"POST",signal:b})).json()},list:async function({signal:a}={}){return(await this.request("/trainings",{method:"GET",signal:a})).json()}}},8335:()=>{},8768:(a,b,c)=>{let{transformFileInputs:d}=c(740);a.exports={create:async function(a){let b,{model:c,version:e,input:f,wait:g,signal:h,...i}=a;if(i.webhook)try{new URL(i.webhook)}catch(a){throw Error("Invalid webhook URL")}let j={};if(g)if("number"==typeof g){let a=Math.max(1,Math.ceil(Number(g))||1);j.Prefer=`wait=${a}`}else j.Prefer="wait";if(e)b=await this.request("/predictions",{method:"POST",headers:j,data:{...i,input:await d(this,f,this.fileEncodingStrategy),version:e},signal:h});else if(c)b=await this.request(`/models/${c}/predictions`,{method:"POST",headers:j,data:{...i,input:await d(this,f,this.fileEncodingStrategy)},signal:h});else throw Error("Either model or version must be specified");return b.json()},get:async function(a,{signal:b}={}){return(await this.request(`/predictions/${a}`,{method:"GET",signal:b})).json()},cancel:async function(a,{signal:b}={}){return(await this.request(`/predictions/${a}/cancel`,{method:"POST",signal:b})).json()},list:async function({signal:a}={}){return(await this.request("/predictions",{method:"GET",signal:a})).json()}}},9021:a=>{"use strict";a.exports=require("fs")},9121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},9288:a=>{"use strict";a.exports=require("sharp")},9294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9748:a=>{"use strict";a.exports=require("fs/promises")}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[586,692],()=>b(b.s=93));module.exports=c})();